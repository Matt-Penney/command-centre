@page "/utilities"
@using System.Diagnostics
@using CommandCentre.Models
@using CommandCentre.Services
@inject UtilityService UtilityService

<Rows>
    <Markup Content="üõ†Ô∏è Utilities" Foreground="@Color.Blue" Decoration="Decoration.Bold" />
    <Newline />

    <TextInput Placeholder="Search Utilities..." 
               Value="@_searchQuery" 
               ValueChanged="@((string value) => { _searchQuery = value; StateHasChanged(); })"
               IsFocused="true"
               FocusedColor="@Color.Blue" />
    <Newline />

    <Select Options="@GetFilteredUtilities().Select(u => $"üõ†Ô∏è {u.Name}").ToArray()"
            Value="@_selectedUtility"
            ValueChanged="@SelectUtility"
            IsFocused="true"
            Expand="true" />

    @if (!GetFilteredUtilities().Any())
    {
        <Markup Content="No utilities match your search" Foreground="@Color.Red" />
    }
    
    <Newline />

    @if (!string.IsNullOrEmpty(_selectedUtility))
    {
        var utility = GetSelectedUtility();
        if (utility != null)
        {
            <Panel Title="@($"‚ÑπÔ∏è {utility.Name}")" BorderColor="@Color.Cyan">
                <Rows>
                    <Markup Content="@utility.Description" Foreground="@Color.Grey" />
                    <Markup Content="@($"Command: {utility.Command}")" Foreground="@Color.Grey70" />
                    <Markup Content="@($"Type: {utility.Type}")" Foreground="@Color.Grey70" />
                    @if (utility.RequiresConfirmation)
                    {
                        <Markup Content="‚ö†Ô∏è Requires confirmation" Foreground="@Color.Yellow" />
                    }
                </Rows>
            </Panel>
            <Newline />
            
            <Columns>
                <TextButton Content="‚ñ∂Ô∏è Execute" OnClick="@(() => ExecuteUtility(utility))" />
                <TextButton Content="‚ùå Cancel" OnClick="@ClearSelection" />
            </Columns>
            <Newline />
        }
    }

    @if (_isExecuting)
    {
        <Spinner />
        <Markup Content="Executing..." Foreground="@Color.Yellow" />
        <Newline />
    }

    @if (!string.IsNullOrEmpty(_output))
    {
        <Panel Title="üìã Output" BorderColor="@Color.Green">
            <Markup Content="@_output" />
        </Panel>
        <Newline />
    }

    @if (!string.IsNullOrEmpty(_error))
    {
        <Panel Title="‚ùå Error" BorderColor="@Color.Red">
            <Markup Content="@_error" Foreground="@Color.Red" />
        </Panel>
        <Newline />
    }
</Rows>

<Markup Content="@($"Selected Utility: {_selectedUtility}")" Foreground="@Color.Grey70" />
<Markup Content="@($"Total utilities loaded: {_utilities.Count}")" Foreground="@Color.Grey70" />

@code {
    private string _searchQuery = "";
    private string _selectedUtility = "";
    private List<UtilityScript> _utilities = new();
    private bool _isExecuting = false;
    private string _output = "";
    private string _error = "";

    protected override void OnInitialized()
    {
        _utilities = UtilityService.GetAllUtilities();
    }

    private void SelectUtility(string utilityName)
    {
        utilityName = utilityName.TrimStart("üõ†Ô∏è ".ToCharArray());

        _selectedUtility = utilityName;
        _output = "";
        _error = "";
        StateHasChanged();
    }

    private async Task ExecuteUtility(UtilityScript utility)
    {
        _output = "";
        _error = "";
        _isExecuting = true;
        StateHasChanged();

        var (success, output, error) = await UtilityService.ExecuteUtility(utility);

        _isExecuting = false;
        _output = output;
        _error = error;
        _selectedUtility = "";
        StateHasChanged();
    }

    private void ClearSelection()
    {
        _selectedUtility = "";
        _output = "";
        _error = "";
        StateHasChanged();
    }

    private IEnumerable<UtilityScript> GetFilteredUtilities()
    {
        if (string.IsNullOrWhiteSpace(_searchQuery))
            return _utilities;
        
        return _utilities.Where(u => 
            u.Name.Contains(_searchQuery, StringComparison.OrdinalIgnoreCase) ||
            u.Description.Contains(_searchQuery, StringComparison.OrdinalIgnoreCase)
        );
    }

    private UtilityScript GetSelectedUtility()
    {
        return _utilities.First(u => u.Name == _selectedUtility);
    }
}