@page "/utilities"

@using CommandCentre.Models
@using CommandCentre.Services
@using CommandCentre.Components

@inject UtilityService UtilityService

<Panel Title="ðŸ› ï¸ Utilities" Border="BoxBorder.None" Expand="true" TitleColor="@Color.Blue">
    <Padder Padding="@(new (0, 1, 0, 0))">
        <Columns Expand="true">
            <Rows>
                <Markup Content="Available Utilities" Decoration="@Decoration.Bold" />
                <Newline />

                <TextInput Placeholder="Search Utilities..." 
                           Value="@_searchQuery" 
                           ValueChanged="@((string value) => { _searchQuery = value; StateHasChanged(); })"
                           OnSubmit="@HandleQuickSearch" />
                <Newline />

                <Select Options="@GetFilteredUtilities().Select(u => $"{u.Name}").ToArray()"
                        Value="@selectedUtility?.Name"
                        ValueChanged="@SelectUtility" />

                @if (!GetFilteredUtilities().Any())
                {
                    <Newline />
                    <Markup Content="No utilities match your search" Foreground="@Color.Red" />
                }
            </Rows>

            <!-- ToDo: windows issue, rendering of this whole section doesnt work -->
            <!-- note: maybe move into its own component, or new page to nav too -->
            @if (selectedUtility != null)
            {
                <Rows>
                    <Markup Content="Selected Utility Details" Decoration="@Decoration.Bold" />
                    <Newline />

                    <!-- Causing render issues, just on Windows it seems -->
                    <Panel Title="@($"â„¹ï¸ {selectedUtility.Name}")" BorderColor="@Color.Cyan">
                        <Rows>
                            <Markup Content="@selectedUtility.Description" Foreground="@Color.Grey" />
                            <Markup Content="@($"Command: {selectedUtility.Command}")" Foreground="@Color.Grey70" />
                            <Markup Content="@($"Type: {selectedUtility.Type}")" Foreground="@Color.Grey70" />
                            @if (selectedUtility.RequiresConfirmation)
                            {
                                @* ToDo: add proper confirmation dialogs when trying to execute *@
                                <Markup Content="âš ï¸ Requires confirmation" Foreground="@Color.Yellow" />
                            }
                        </Rows>
                    </Panel>
                    <Newline />
                    
                    <Columns>
                        <TextButton Content="â–¶ï¸ Execute" OnClick="@(() => ExecuteUtility(selectedUtility))" />
                        <TextButton Content="âŒ Cancel" OnClick="@ClearSelection" />
                    </Columns>
                </Rows>
            }

            @if (_isExecuting || !string.IsNullOrEmpty(_output))
            {
                <Rows>
                    <Markup Content="Result:" Decoration="@Decoration.Bold" />
                    <Newline />

                    @if (!string.IsNullOrEmpty(_output))
                    {
                        <Panel Title="ðŸ“‹ Output" BorderColor="@Color.Green">
                            <Markup Content="@_output" />
                        </Panel>
                    }
                    else if (_isExecuting)
                    {
                        <LoadingSpinner loadingMessage="Executing..." />
                    }

                    <ErrorMessagePanel errorMessage="@_error" />
                </Rows>
            }
        </Columns>
    </Padder>
</Panel>

@code {
    private string _searchQuery = "";
    private UtilityScript selectedUtility = null;
    private List<UtilityScript> _utilities = new();
    private bool _isExecuting = false;
    private string _output = "";
    private string _error = "";

    protected override void OnInitialized()
    {
        _utilities = UtilityService.GetAllUtilities();
    }

    private void SelectUtility(string utilityName)
    {
        var utility = UtilityService.GetByName(utilityName);
        if (utility == null)
        {
            throw new InvalidOperationException($"Utility '{utilityName}' not found.");
        }
        
        selectedUtility = utility;
        _output = "";
        _error = "";
        StateHasChanged();
    }

    private async Task ExecuteUtility(UtilityScript utility)
    {
        _output = "";
        _error = "";
        _isExecuting = true;
        StateHasChanged();

        var (success, output, error) = await UtilityService.ExecuteUtility(utility);

        _isExecuting = false;
        _output = output;
        _error = success ? string.Empty : error;
        StateHasChanged();
    }

    private void ClearSelection()
    {
        selectedUtility = null;
        _output = "";
        _error = "";
        StateHasChanged();
    }

    private IEnumerable<UtilityScript> GetFilteredUtilities()
    {
        if (string.IsNullOrWhiteSpace(_searchQuery))
            return _utilities;
        
        return _utilities.Where(u => 
            u.Name.Contains(_searchQuery, StringComparison.OrdinalIgnoreCase) ||
            u.Description.Contains(_searchQuery, StringComparison.OrdinalIgnoreCase)
        );
    }

    private void HandleQuickSearch()
    {
        if (string.IsNullOrWhiteSpace(_searchQuery)) return;

        var matches = GetFilteredUtilities().ToList();

        if (matches.Any() && matches.Count == 1)
        {
            selectedUtility = matches[0];
            
            _searchQuery = "";
        }
        
        StateHasChanged();
        // ToDo: focus on execute button
    }
}