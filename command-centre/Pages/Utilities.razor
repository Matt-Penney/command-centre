@page "/utilities"
@using System.Diagnostics
@using CommandCentre.Models
@using CommandCentre.Services
@inject UtilityService UtilityService

<Panel Title="ðŸ› ï¸ Utilities" Border="BoxBorder.None" Expand="true" TitleColor="@Color.Blue">
    <Padder Padding="@(new (0, 1, 0, 0))">
        <Columns Expand="true">
            <Rows>
                <Markup Content="Available Utilities" Decoration="@Decoration.Bold" />

                <TextInput Placeholder="Search Utilities..." 
                        Value="@_searchQuery" 
                        ValueChanged="@((string value) => { _searchQuery = value; StateHasChanged(); })"
                        FocusedColor="@Color.Blue" />
                <Newline />

                <Select Options="@GetFilteredUtilities().Select(u => $"{u.Name}").ToArray()"
                        Value="@_selectedUtility"
                        ValueChanged="@SelectUtility" />

                @if (!GetFilteredUtilities().Any())
                {
                    <Nelwine />
                    <Markup Content="No utilities match your search" Foreground="@Color.Red" />
                }
            </Rows>
            @if (!string.IsNullOrEmpty(_selectedUtility))
            {
                <Rows>
                    <Markup Content="Selected Utility" Decoration="@Decoration.Bold" />
                    @if (!string.IsNullOrEmpty(_selectedUtility))
                    {
                        var utility = GetSelectedUtility();
                        if (utility != null)
                        {
                            <Panel Title="@($"â„¹ï¸ {utility.Name}")" BorderColor="@Color.Cyan">
                                <Rows>
                                    <Markup Content="@utility.Description" Foreground="@Color.Grey" />
                                    <Markup Content="@($"Command: {utility.Command}")" Foreground="@Color.Grey70" />
                                    <Markup Content="@($"Type: {utility.Type}")" Foreground="@Color.Grey70" />
                                    @if (utility.RequiresConfirmation)
                                    {
                                        <Markup Content="âš ï¸ Requires confirmation" Foreground="@Color.Yellow" />
                                    }
                                </Rows>
                            </Panel>
                            <Newline />
                            
                            <Columns>
                                <TextButton Content="â–¶ï¸ Execute" OnClick="@(() => ExecuteUtility(utility))" />
                                <TextButton Content="âŒ Cancel" OnClick="@ClearSelection" />
                            </Columns>
                        }
                    }
                </Rows>
            }
            @if (_isExecuting || !string.IsNullOrEmpty(_output) || !string.IsNullOrEmpty(_error))
            {
                <Rows>
                    <Markup Content="Result:" Decoration="@Decoration.Bold" />
                    @if (_isExecuting)
                    {
                        <Spinner />
                        <Markup Content="Executing..." Foreground="@Color.Yellow" />
                        <Newline />
                    }

                    @if (!string.IsNullOrEmpty(_output))
                    {
                        <Panel Title="ðŸ“‹ Output" BorderColor="@Color.Green">
                            <Markup Content="@_output" />
                        </Panel>
                        <Newline />
                    }

                    @if (!string.IsNullOrEmpty(_error))
                    {
                        <Panel Title="âŒ Error" BorderColor="@Color.Red">
                            <Markup Content="@_error" Foreground="@Color.Red" />
                        </Panel>
                    }
                </Rows>
            }
        </Columns>
    </Padder>
</Panel>

@code {
    private string _searchQuery = "";
    private string _selectedUtility = "";
    private List<UtilityScript> _utilities = new();
    private bool _isExecuting = false;
    private string _output = "";
    private string _error = "";

    protected override void OnInitialized()
    {
        _utilities = UtilityService.GetAllUtilities();
    }

    private void SelectUtility(string utilityName)
    {
        _selectedUtility = utilityName;
        _output = "";
        _error = "";
        StateHasChanged();
    }

    private async Task ExecuteUtility(UtilityScript utility)
    {
        _output = "";
        _error = "";
        _isExecuting = true;
        StateHasChanged();

        var (success, output, error) = await UtilityService.ExecuteUtility(utility);

        _isExecuting = false;
        _output = output;
        _error = error;
        StateHasChanged();
    }

    private void ClearSelection()
    {
        _selectedUtility = "";
        _output = "";
        _error = "";
        StateHasChanged();
    }

    private IEnumerable<UtilityScript> GetFilteredUtilities()
    {
        if (string.IsNullOrWhiteSpace(_searchQuery))
            return _utilities;
        
        return _utilities.Where(u => 
            u.Name.Contains(_searchQuery, StringComparison.OrdinalIgnoreCase) ||
            u.Description.Contains(_searchQuery, StringComparison.OrdinalIgnoreCase)
        );
    }

    private UtilityScript GetSelectedUtility()
    {
        return _utilities.First(u => u.Name == _selectedUtility);
    }
}