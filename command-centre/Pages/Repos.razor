@page "/repos"
@using System.Diagnostics
@inject RepoService RepoService
@inject GitHubService GitHubService

<Panel Title="üìÅ Repositories" Border="BoxBorder.None" Expand="true" TitleColor="@Color.Blue">
    <Padder Padding="@(new (0, 1, 0, 0))">
        <Columns Expand="true">
            <Rows>
                <Markup Content="Manage your local repos" Decoration="@Decoration.Bold" />
                <Newline />

                <TextInput Placeholder="Search Repositories..." 
                           Value="@searchQuery" 
                           ValueChanged="@((string value) => { searchQuery = value; StateHasChanged(); })"
                           FocusedColor="@Color.Blue" />
                <Newline />

                 <Select Options="@GetFilteredRepos().Select(r => $"{r.Name}").ToArray()"
                         Value="@selectedRepo?.Name"
                         ValueChanged="@SelectRepo" />

                @if (!GetFilteredRepos().Any())
                {
                    <Markup Content="No repos match your search" Foreground="@Color.Red" />
                }
            </Rows>

            <!-- ToDo: windows issue, rendering of this whole section doesnt work -->
            <!-- note: maybe move into its own component, or new page to nav too -->
            @if (selectedRepo != null)
            {
                @* maybe look into FocusOrder and stuff, maybe having the second panel have a lower focus index than the select list, then on appearing it will focus onto the second panel *@
                <Rows>
                    <Markup Content="Selected Repository Details" Decoration="@Decoration.Bold" />
                    <Newline />
                
                    <!-- Causing render issues, just on Windows it seems -->
                    <Panel Title="@($"‚ÑπÔ∏è {selectedRepo.Name}")" BorderColor="@Color.Cyan">
                        <Rows>
                            <Markup Content="@($"Active: {GetActiveStatusMarkup(selectedRepo.IsActive)}")" />
                            <Markup Content="@($"Path: {selectedRepo.Path}")" Foreground="@Color.Grey70" />
                            <Markup Content="@($"Type: {selectedRepo.Type}")" Foreground="@Color.Grey70" />
                            <Newline />

                            @if (selectedRepo.IsActive == true || selectedRepo.Type == "wsl")
                            {   
                                <Markup Content="Open with:" Decoration="@Decoration.Underline" />
                                <Rows>
                                    <TextButton Content="‚ñ∂Ô∏è IDE" OnClick="@(() => OpenToIde(selectedRepo))" />
                                    <TextButton Content="üìë Browser" OnClick="@(() => OpenToBrowser(selectedRepo))" />
                                    <TextButton Content="üóÇÔ∏è Folder" OnClick="@(() => OpenToFolder(selectedRepo))" />
                                </Rows>
                            }
                            else
                            {
                                <Markup Content="Repository is inactive. Actions not available." Foreground="@Color.Red" />
                            }
                        </Rows>
                    </Panel>
                </Rows>
            }
        </Columns>
    </Padder>
</Panel>

@* TODO list *@
@* /Components/Repo/~ implement components *@
@* latest release version (with date created) if releases dont exist then dont show panel *@

@code {
    private string searchQuery = "";
    private RepoInfo selectedRepo = null;
    private List<RepoInfo> _repos = new();

    protected override void OnInitialized()
    {
        _repos = RepoService.GetAllRepos();
    }

    private string GetActiveStatusMarkup(bool? isActive)
    {
        if (isActive == null)
        {
            return "‚ùì";
        }
        else
        {
            return isActive.Value ? "‚úÖ" : "‚ùå";
        }
    }

    private void SelectRepo(string repoName)
    {
        var repo = RepoService.GetByName(repoName);
        if (repo == null)
        {
            throw new InvalidOperationException($"Repo '{repoName}' not found.");
        }
        selectedRepo = repo;
        StateHasChanged();
    }

    private void UpdateSearch(string value)
    {
        searchQuery = value;
        StateHasChanged();
    }

    private IEnumerable<RepoInfo> GetFilteredRepos()
    {
        if (string.IsNullOrWhiteSpace(searchQuery))
            return _repos;
        
        return RepoService.GetFilteredRepos(searchQuery);
    }

    private void OpenToIde(RepoInfo repo)
    {
        // ToDo: refactor repoService - what exactly does this mean
        RepoService.OpenToIDE(repo);
        return;
    }
    private async Task OpenToBrowser(RepoInfo repo)
    {
        @* ToDo: implement better error handling *@
        var url = await GitHubService.GetRepoBrowserUrl(repo);  
        
        Process.Start(new ProcessStartInfo
        {
            FileName = url,
            UseShellExecute = true
        });

        return;
    }
    private async Task OpenToFolder(RepoInfo repo)
    {
        if (OperatingSystem.IsMacOS())
        {
            System.Diagnostics.Process.Start("open", repo.Path);
            return;
        }
        else if (OperatingSystem.IsWindows())
        {
            System.Diagnostics.Process.Start("explorer.exe", repo.Path);
            return;
        }

        return;
    }
}