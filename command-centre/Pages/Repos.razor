@page "/repos"

<Rows>
    <TextInput Placeholder="Search repos..." 
           Value="@searchQuery" 
           ValueChanged="@((string value) => { searchQuery = value; StateHasChanged(); })"
           OnSubmit="@HandleEnter"
           FocusedColor="@Color.Blue" />
    <Newline />

    <Select Options="@GetFilteredRepos().Select(r => $"ðŸ“ {r.Name}").ToArray()"
        Value="@SelectedRepo"
        ValueChanged="@SelectRepo"
        OnSelected="@HandleEnter"
        IsFocused="true"
        Expand="true" />

    <Markup Content="@($"Selected Repo: {SelectedRepo}")" Foreground="@Color.Grey70" />
</Rows>

@if (!GetFilteredRepos().Any())
{
    <Markup Content="[yellow]No repos match your search[/]" />
}

@code {
    private string searchQuery = "";
    
    private string SelectedRepo = "";
    private readonly List<RepoInfo> _repos = new()
    {
        new RepoInfo { Name = "customer-portal", Path = "/Users/matthewpenney/repos/customer-portal" },
        new RepoInfo { Name = "devops", Path = "/Users/matthewpenney/devops" },
        new RepoInfo { Name = "infrastructure", Path = "/Users/matthewpenney/repos/infrastructure" },
        new RepoInfo { Name = "ignite-portal", Path = "/Users/matthewpenney/repos/ignite-portal" },
        new RepoInfo { Name = "ignite", Path = "/Users/matthewpenney/repos/ignite" }
    };

    private void SelectRepo(string repoName)
    {
        repoName = repoName.TrimStart("ðŸ“ ".ToCharArray());

        var key = _repos.FirstOrDefault(r => r.Name == repoName).Name;
        if (key == null)
        {
            throw new InvalidOperationException($"Tab '{repoName}' not found.");
        }
        SelectedRepo = repoName;
        StateHasChanged();

        OpenInVSCode(_repos.First(r => r.Name == SelectedRepo).Path);
    }

    private void UpdateSearch(string value)
    {
        searchQuery = value;
        StateHasChanged();
    }

    private void HandleEnter()
    {
        var filtered = GetFilteredRepos().ToList();
        
        if (!filtered.Any())
        {
            return;
        }

        if (filtered.Count == 1)
        {
            OpenInVSCode(filtered[0].Path);
        }
    }

    private IEnumerable<RepoInfo> GetFilteredRepos()
    {
        if (string.IsNullOrWhiteSpace(searchQuery))
            return _repos;
        
        return _repos.Where(r => r.Name.Contains(searchQuery, StringComparison.OrdinalIgnoreCase));
    }

    private void OpenInVSCode(string path)
    {
        try
        {
            var process = new Process
            {
                StartInfo = new ProcessStartInfo
                {
                    FileName = "code",
                    Arguments = $"\"{path}\"",
                    UseShellExecute = true,
                    CreateNoWindow = true
                }
            };
            process.Start();
        }
        catch (Exception ex)
        {
            // Handle error
        }
    }

    private class RepoInfo
    {
        public string Name { get; set; } = "";
        public string Path { get; set; } = "";
    }
}