@page "/repos"

<Rows>
    <TextInput Placeholder="Search repos..." 
           Value="@searchQuery" 
           ValueChanged="@((string value) => { searchQuery = value; StateHasChanged(); })"
           OnSubmit="@HandleEnter"
           FocusedColor="@Color.Blue" />
    <Newline />

    <Select Options="@GetFilteredRepos().Select(r => $"ðŸ“ {r.Name}").ToArray()"
        Value="@SelectedRepo"
        ValueChanged="@SelectRepo"
        OnSelected="@HandleEnter"
        IsFocused="true"
        Expand="true" />

    <Markup Content="@($"Selected Repo: {SelectedRepo}")" Foreground="@Color.Grey70" />
</Rows>

@if (!GetFilteredRepos().Any())
{
    <Markup Content="[yellow]No repos match your search[/]" />
}

@code {
    private string searchQuery = "";
    
    private string SelectedRepo = "";
    private readonly List<RepoInfo> _repos = new()
    {
        new RepoInfo { Name = "customer-portal", Path = "/Users/matthewpenney/repos/customer-portal", Type = "wsl" },
        new RepoInfo { Name = "devops", Path = "/Users/matthewpenney/devops" },
        new RepoInfo { Name = "infrastructure", Path = "/Users/matthewpenney/repos/infrastructure" },
        new RepoInfo { Name = "ignite-portal", Path = "/Users/matthewpenney/repos/ignite-portal" },
        new RepoInfo { Name = "ignite", Path = "/Users/matthewpenney/repos/ignite" },
        new RepoInfo { Name = "portfolio", Path = "/Users/matthewpenney/repos/portfolio" }
    };

    private void SelectRepo(string repoName)
    {
        repoName = repoName.TrimStart("ðŸ“ ".ToCharArray());

        var key = _repos.FirstOrDefault(r => r.Name == repoName).Name;
        if (key == null)
        {
            throw new InvalidOperationException($"Tab '{repoName}' not found.");
        }
        SelectedRepo = repoName;
        StateHasChanged();

        OpenInVSCode(_repos.First(r => r.Name == SelectedRepo).Path);
    }

    private void UpdateSearch(string value)
    {
        searchQuery = value;
        StateHasChanged();
    }

    private void HandleEnter()
    {
        var filtered = GetFilteredRepos().ToList();
        
        if (!filtered.Any())
        {
            return;
        }

        if (filtered.Count == 1)
        {
            SelectRepo(filtered[0].Name);
        }
    }

    private IEnumerable<RepoInfo> GetFilteredRepos()
    {
        if (string.IsNullOrWhiteSpace(searchQuery))
            return _repos;
        
        return _repos.Where(r => r.Name.Contains(searchQuery, StringComparison.OrdinalIgnoreCase));
    }

    private void OpenInVSCode(string path)
    {
        try
        {
            var repo = _repos.First(r => r.Path == path);
            string command;

            if (repo.Type == "wsl")
            {
                // For WSL repos, use ubuntu command to open in VS Code
                command = $"ubuntu run code '{path}'";
            }
            else
            {
                // For regular repos, use macOS 'open' command with VS Code
                command = $"open -a 'Visual Studio Code' '{path}'";
            }

            Console.WriteLine($"Running command: {command}");

            var process = new Process
            {
                StartInfo = new ProcessStartInfo
                {
                    FileName = "/bin/bash",
                    Arguments = $"-c \"{command}\"",
                    UseShellExecute = false,
                    RedirectStandardOutput = true,
                    RedirectStandardError = true,
                    CreateNoWindow = true
                }
            };
            process.Start();
            
            string output = process.StandardOutput.ReadToEnd();
            string error = process.StandardError.ReadToEnd();
            
            process.WaitForExit();
            
            if (!string.IsNullOrEmpty(output))
                Console.WriteLine($"Output: {output}");
            if (!string.IsNullOrEmpty(error))
                Console.WriteLine($"Error: {error}");
                
            Console.WriteLine($"Exit code: {process.ExitCode}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error opening VS Code: {ex.Message}");
        }
    }

    private class RepoInfo
    {
        public string Name { get; set; } = "";
        public string Path { get; set; } = "";
        public string Type { get; set; } = "code";
    }
}