@page "/repositories"

@using CommandCentre.Models
@using CommandCentre.Services
@using CommandCentre.Components.Repo

@inject RepoService RepoService

<Panel Title="ðŸ“ Repositories" Border="BoxBorder.None" Expand="true" TitleColor="@Color.Blue">
    <Padder Padding="@(new (0, 1, 0, 0))">
        <Columns Expand="true">
            <Rows>
                <Markup Content="Manage your local repos" Decoration="@Decoration.Bold" />
                <Newline />

                <TextInput Placeholder="Search Repositories..." 
                           Value="@searchQuery" 
                           ValueChanged="@((string value) => { searchQuery = value; StateHasChanged(); })"
                           OnSubmit="@HandleQuickSearch" />
                <Newline />

                 <Select Options="@GetFilteredRepos().Select(r => $"{r.Name}").ToArray()"
                         Value="@selectedRepo?.Name"
                         ValueChanged="@SelectRepo" />

                @if (!GetFilteredRepos().Any())
                {
                    <Markup Content="No repos match your search" Foreground="@Color.Red" />
                }
            </Rows>

            <!-- ToDo: windows issue, rendering of this whole section doesnt work -->
            <Rows>
                <RepoDetailsPanel selectedRepo="@selectedRepo" />
            </Rows>
            <Rows>
                <RepoActionsPanel selectedRepo="@selectedRepo" />
            </Rows>
        </Columns>
    </Padder>
</Panel>

@* TODO list *@
@* /Components/Repo/~ implement components *@

@code {
    private string searchQuery = "";
    private Repo selectedRepo = null;
    private List<Repo> _repos = new();

    protected override void OnInitialized()
    {
        _repos = RepoService.GetAllRepos();
    }

    private void SelectRepo(string repoName)
    {
        var repo = RepoService.GetByName(repoName);
        if (repo == null)
        {
            throw new InvalidOperationException($"Repo '{repoName}' not found.");
        }
        selectedRepo = repo;
        StateHasChanged();
    }

    private void UpdateSearch(string value)
    {
        searchQuery = value;
        StateHasChanged();
    }

    private IEnumerable<Repo> GetFilteredRepos()
    {
        if (string.IsNullOrWhiteSpace(searchQuery))
            return _repos;
        
        return RepoService.GetFilteredRepos(searchQuery);
    }

    private void HandleQuickSearch()
    {
        if (string.IsNullOrWhiteSpace(searchQuery)) return;

        var matches = GetFilteredRepos().ToList();

        if (matches.Any() && matches.Count == 1)
        {
            selectedRepo = matches[0];
            
            searchQuery = "";
        }
        
        StateHasChanged();
        // ToDo: focus on selected repo actions panel
    }
}