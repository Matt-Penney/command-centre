@page "/repos"
@using System.Diagnostics
@using CommandCentre.Models
@using CommandCentre.Services
@inject RepoService RepoService

<Panel Title="üìÅ Repositories" Border="BoxBorder.None" Expand="true" TitleColor="@Color.Blue">
    <Padder Padding="@(new (0, 1, 0, 0))">
        <Columns Expand="true">
            <Rows>
                <Markup Content="Manage your local repos" Decoration="Decoration.Bold" />
                <Newline />

                <TextInput Placeholder="Search Repositories..." 
                           Value="@searchQuery" 
                           ValueChanged="@((string value) => { searchQuery = value; StateHasChanged(); })"
                           FocusedColor="@Color.Blue" />
                <Newline />

                 <Select Options="@GetFilteredRepos().Select(r => $"{r.Name}").ToArray()"
                         Value="@selectedRepo?.Name"
                         ValueChanged="@SelectRepo" />

                @if (!GetFilteredRepos().Any())
                {
                    <Markup Content="No repos match your search" Foreground="@Color.Red" />
                }
            </Rows>

            @if (selectedRepo != null)
            {
                <Rows>
                    <Markup Content="Selected Repository Details" Decoration="@Decoration.Bold" />
                    <Newline />
                
                    <Panel Title="@($"‚ÑπÔ∏è {selectedRepo.Name}")" BorderColor="@Color.Cyan">
                        <Rows>
                            <Markup Content="@($"Active: {GetActiveStatusMarkup(selectedRepo.IsActive.Value)}")" />
                            <Markup Content="@($"Path: {selectedRepo.Path}")" Foreground="@Color.Grey70" />
                            <Markup Content="@($"Type: {selectedRepo.Type}")" Foreground="@Color.Grey70" />
                            <Newline />

                            <Markup Content="Open with:" Decoration="@Decoration.Underline" />
                            <Rows>
                                <TextButton Content="‚ñ∂Ô∏è IDE" OnClick="@(() => OpenToIde(selectedRepo))" />
                                <TextButton Content="üìë Browser" OnClick="@(() => OpenToBrowser(selectedRepo))" />
                                <TextButton Content="üóÇÔ∏è Folder" OnClick="@(() => OpenToFolder(selectedRepo))" />
                            </Rows>
                        </Rows>
                    </Panel>
                </Rows>
            }
        </Columns>
    </Padder>
</Panel>

@if(selectedRepo != null)
{
    @* TODO list *@
    @* recent commits list, number of commits in last X days, Show more info button to extend details (like PullRequestPanel) *@
        @* gh search commits QUERY --repo repo.name --owner repo.owner ----- something like this, best we got *@
    @* CI/CD pipeline status, green or red emoji if red then maybe a link to error / pipeline *@
    @* latest release version (with date created) if releases dont exist then dont show panel *@
    @* repo health indicators, not 100% on what this is yet, maybe tests *@
    @* Commit frequency chart (last 30 days) (bar chart) *@
}

@code {
    private string searchQuery = "";
    private RepoInfo selectedRepo = null;
    private List<RepoInfo> _repos = new();

    protected override void OnInitialized()
    {
        _repos = RepoService.GetAllRepos();
    }

    private string GetActiveStatusMarkup(bool isActive)
    {
        return isActive ? "‚úÖ" : "‚ùå";
    }

    private void SelectRepo(string repoName)
    {
        var repo = RepoService.GetByName(repoName);
        if (repo == null)
        {
            throw new InvalidOperationException($"Repo '{repoName}' not found.");
        }
        selectedRepo = repo;
        StateHasChanged();
    }

    private void UpdateSearch(string value)
    {
        searchQuery = value;
        StateHasChanged();
    }

    private IEnumerable<RepoInfo> GetFilteredRepos()
    {
        if (string.IsNullOrWhiteSpace(searchQuery))
            return _repos;
        
        return RepoService.GetFilteredRepos(searchQuery);
    }

    private async Task OpenToIde(RepoInfo repo)
    {
        // To Do: refactor repoService
        RepoService.OpenToIDE(repo);
        return;
    }
    private async Task OpenToBrowser(RepoInfo repo)
    {
        @* ToDo implement open to browser *@
        return;
    }
    private async Task OpenToFolder(RepoInfo repo)
    {
        @* ToDo implement open to folder directory *@
        return;
    }
}