@page "/repos"
@using System.Diagnostics
@using CommandCentre.Models
@using CommandCentre.Services
@inject RepoService RepoService

<Rows>
    <Markup Content="ðŸ“ Repositories" Foreground="@Color.Blue" Decoration="Decoration.Bold" />
    <Newline />

    <TextInput Placeholder="Search repos..." 
           Value="@searchQuery" 
           ValueChanged="@((string value) => { searchQuery = value; StateHasChanged(); })"
           OnSubmit="@HandleEnter"
           FocusedColor="@Color.Blue" />
    <Newline />

    <Select Options="@GetFilteredRepos().Select(r => $"ðŸ“ {r.Name}").ToArray()"
        Value="@SelectedRepo"
        ValueChanged="@SelectRepo"
        OnSelected="@HandleEnter"
        IsFocused="true"
        Expand="true" />

    <Markup Content="@($"Selected Repo: {SelectedRepo}")" Foreground="@Color.Grey70" />
</Rows>

@if (!GetFilteredRepos().Any())
{
    <Markup Content="[yellow]No repos match your search[/]" />
}

@code {
    private string searchQuery = "";
    private string SelectedRepo = "";
    private List<RepoInfo> _repos = new();

    protected override void OnInitialized()
    {
        _repos = RepoService.GetAllRepos();
    }

    private void SelectRepo(string repoName)
    {
        repoName = repoName.TrimStart("ðŸ“ ".ToCharArray());

        var repo = _repos.FirstOrDefault(r => r.Name == repoName);
        if (repo == null)
        {
            throw new InvalidOperationException($"Repo '{repoName}' not found.");
        }
        SelectedRepo = repoName;
        StateHasChanged();

        RepoService.OpenRepo(repo);
    }

    private void UpdateSearch(string value)
    {
        searchQuery = value;
        StateHasChanged();
    }

    private void HandleEnter()
    {
        var filtered = GetFilteredRepos().ToList();
        
        if (!filtered.Any())
        {
            return;
        }

        if (filtered.Count == 1)
        {
            SelectRepo(filtered[0].Name);
        }
    }

    private IEnumerable<RepoInfo> GetFilteredRepos()
    {
        if (string.IsNullOrWhiteSpace(searchQuery))
            return _repos;
        
        return _repos.Where(r => r.Name.Contains(searchQuery, StringComparison.OrdinalIgnoreCase));
    }
}