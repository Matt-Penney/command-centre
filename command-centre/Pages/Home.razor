@page "/"
@page "/home"

@using System.Diagnostics
@using CommandCentre.Components.Home
@using CommandCentre.Components
@using CommandCentre.Services
@using CommandCentre.Models

@implements IDisposable

@inject RepoService RepoService
@inject NavigationManager Navigation

<Rows>
    <Markup Content="@($"âš¡ï¸ Dashboard - {now}")" Foreground="@Color.Blue" Decoration="@Decoration.Bold" />
    <Newline />
    
    @* Global Search Bar *@
    <!-- ToDO: windows issue, on successful search it gets stuck, doesnt clear either, pasas error message as prop -->
    <Columns>
        <TextInput Placeholder="ðŸ” Quick search repos (press Enter)..." 
                   Value="@_searchQuery" 
                   ValueChanged="@((string value) => { _searchQuery = value; StateHasChanged(); })"
                   OnSubmit="@HandleQuickSearch" />

        <ErrorMessagePanel errorMessage="@_searchError" />
    </Columns>
    <Newline />

    <Columns>
        <SystemStatsPanel />
        <Newline />
        <TasksPanel />
        <Newline />
        @*For no obvious reason, this is causing render issues, fixed it seems *@
        <TimeTrackerPanel /> 
    </Columns>

    <Newline />

    <Columns>
        <GitStatusPanel /> <!-- ToDo: run commands after build rather than before, speed up firt build -->
        <Newline />
        <PullRequestsPanel /> <!-- ToDo: run commands after build rather than before, speed up firt build -->
    </Columns>
</Rows>

@code {
    private string _searchQuery = string.Empty;
    private string _searchError = string.Empty;

    private string now = DateTime.Now.ToString("HH:mmtt");
    private System.Timers.Timer? _timer;
    private bool _disposed = false;

    private List<RepoInfo> _repos = new();

    protected override async Task OnInitializedAsync()
    {
        _repos = RepoService.GetAllRepos();

        // Update every 30 seconds
        _timer = new System.Timers.Timer(30000);
        _timer.Elapsed += async (s, e) =>
        {
            if (!_disposed) await GetCurrentTime();
        };
        _timer.Start();
    }

    private async Task GetCurrentTime()
    {
        now = DateTime.Now.ToString("HH:mmtt");

        if (!_disposed) await InvokeAsync(StateHasChanged);
    }

    private void HandleQuickSearch()
    {
        if (string.IsNullOrWhiteSpace(_searchQuery)) return;

        var matches = RepoService.GetFilteredRepos(_searchQuery);

        if (matches.Count == 1)
        {
            var success = RepoService.OpenToIDE(matches[0]);

            if (!success)
            {
                _searchError = matches[0].IsActive == false
                    ? $"Repo '{matches[0].Name}' is inactive."
                    : $"Opening repo '{matches[0].Name}'' failed.";
            }
            
            _searchQuery = "";
        }
        else if (matches.Count > 1)
        {
            _searchError = $"Multiple repos found matching '{_searchQuery}'. Please refine your search.";
        }
        else
        {
            _searchError = $"No repos found matching '{_searchQuery}'.";
        }
        
        StateHasChanged();
    }

    public void Dispose()
    {
        _disposed = true;
        _timer?.Dispose();
    }
}