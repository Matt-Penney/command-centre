@page "/"
@page "/home"
@using System.Diagnostics
@using CommandCentre.Models
@using CommandCentre.Services
@using CommandCentre.Components
@inject RepoService RepoService
@inject NavigationManager Navigation
@implements IDisposable

<Rows>
    <Markup Content="@($"âš¡ï¸ Dashboard - {now}")" Foreground="@Color.Blue" Decoration="Decoration.Bold" />
    <Newline />
    
    @* Global Search Bar *@
    <Columns>
        <TextInput Placeholder="ðŸ” Quick search repos (press Enter)..." 
                   Value="@_searchQuery" 
                   ValueChanged="@((string value) => { _searchQuery = value; StateHasChanged(); })"
                   OnSubmit="@HandleQuickSearch"
                   IsFocused="true"
                   FocusedColor="@Color.Blue" />

        @if (!string.IsNullOrWhiteSpace(_searchError))
        {
            <Markup Content="@_searchError" Foreground="@Color.Red" />
        }
    </Columns>
    <Newline />

    <Columns>
        <SystemStatsPanel />
        <Newline />
        <TasksPanel />
    </Columns>

    <Newline />

    <Columns>
        <GitStatusPanel />
        <Newline />
        <PullRequestsPanel />
    </Columns>

    <Newline />

    <Columns>
        <TimeTrackerPanel /> @*For no obvious reason, this is causing render issues, fixed it seems *@
    </Columns>
</Rows>

@code {
    private string _searchQuery = "";
    private string _searchError = "";

    private string now = DateTime.Now.ToString("HH:mmtt");
    private System.Timers.Timer? _timer;
    private bool _disposed = false;

    private List<RepoInfo> _repos = new();

    protected override async Task OnInitializedAsync()
    {
        _repos = RepoService.GetAllRepos();

        // Update every 30 seconds
        _timer = new System.Timers.Timer(30000);
        _timer.Elapsed += async (s, e) =>
        {
            if (!_disposed) await GetCurrentTime();
        };
        _timer.Start();
    }

    private async Task GetCurrentTime()
    {
        now = DateTime.Now.ToString("HH:mmtt");

        if (!_disposed) await InvokeAsync(StateHasChanged);
    }
    
    private void HandleQuickSearch()
    {
        if (string.IsNullOrWhiteSpace(_searchQuery)) return;

        var matches = _repos.Where(r => r.Name.Contains(_searchQuery, StringComparison.OrdinalIgnoreCase)).ToList();
        
        if (matches.Count == 1)
        {
            var success = RepoService.OpenToIDE(matches[0]);

            if (!success)
            {
                _searchError = $"Error opening repo: {matches[0].Name}";
                StateHasChanged();
                return;
            }
            
            _searchQuery = "";
        }
        else if (matches.Any())
        {
            Navigation.NavigateTo("/repos");
        }
        
        StateHasChanged();
    }

    public void Dispose()
    {
        _disposed = true;
        _timer?.Dispose();
    }
}