@page "/"
@page "/home"
@using System.Diagnostics
@using CommandCentre.Models
@using CommandCentre.Services
@using CommandCentre.Components
@inject RepoService RepoService
@inject NavigationManager Navigation

<Rows>
    <Markup Content="âš¡ï¸ Dashboard" Foreground="@Color.Blue" Decoration="Decoration.Bold" />
    <Newline />
    
    @* Global Search Bar *@
    <TextInput Placeholder="ðŸ” Quick search repos (press Enter)..." 
           Value="@_searchQuery" 
           ValueChanged="@((string value) => { _searchQuery = value; StateHasChanged(); })"
           OnSubmit="@HandleQuickSearch"
           IsFocused="true"
           FocusedColor="@Color.Blue" />
    <Newline />

    <Columns>
        <SystemStatsPanel />
        <Newline />
        <GitStatusPanel />
        <Newline />
        <PullRequestsPanel />
    </Columns>

    <Newline />

    <Columns>
        <TasksPanel />
        <Newline />
        <TimeTrackerPanel />
    </Columns>
</Rows>

@code {
    private string _searchQuery = "";
    
    private List<RepoInfo> _repos = new();

    protected override async Task OnInitializedAsync()
    {
        _repos = RepoService.GetAllRepos();
    }
    
    private void HandleQuickSearch()
    {
        if (string.IsNullOrWhiteSpace(_searchQuery)) return;

        var matches = _repos.Where(r => r.Name.Contains(_searchQuery, StringComparison.OrdinalIgnoreCase)).ToList();
        
        if (matches.Count == 1)
        {
            RepoService.OpenRepo(matches[0]);
            _searchQuery = "";
        }
        else if (matches.Any())
        {
            Navigation.NavigateTo("/repos");
        }
        
        StateHasChanged();
    }
}