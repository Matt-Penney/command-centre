@namespace CommandCentre.Components

@using Microsoft.AspNetCore.Components
@using RazorConsole.Components
@using Spectre.Console
@using System.Diagnostics

<Markup Content="ðŸ“¦ [bold purple]Repository Manager[/]" />
<Newline />
<TextInput Placeholder="Search repos..." 
           Value="@searchQuery" 
           ValueChanged="@((string value) => { searchQuery = value; StateHasChanged(); })"
           OnSubmit="@HandleEnter"
           FocusedColor="@Color.Blue" />
<Newline />
<Newline />

<Rows>
    @foreach (var repo in GetFilteredRepos())
    {
        <TextButton Content="@($"ðŸ“ {repo.Name}")"
                    BackgroundColor="@Color.Grey"
                    FocusedColor="@Color.Blue"
                    OnClick="@(() => OpenInVSCode(repo.Path))" />
        <Newline />
    }
</Rows>

@if (!GetFilteredRepos().Any())
{
    <Markup Content="[yellow]No repos match your search[/]" />
}

@code {
    private string searchQuery = "";
    
    private List<RepoInfo> repos = new()
    {
        new RepoInfo { Name = "customer-portal", Path = "/Users/matthewpenney/repos/customer-portal" },
        new RepoInfo { Name = "devops", Path = "/Users/matthewpenney/devops" },
        new RepoInfo { Name = "infrastructure", Path = "/Users/matthewpenney/repos/infrastructure" },
        new RepoInfo { Name = "ignite-portal", Path = "/Users/matthewpenney/repos/ignite-portal" },
        new RepoInfo { Name = "ignite", Path = "/Users/matthewpenney/repos/ignite" }
    };

    private void UpdateSearch(string value)
    {
        searchQuery = value;
        StateHasChanged();
    }

    private void HandleEnter()
    {
        var filtered = GetFilteredRepos().ToList();
        
        // If only one result, open it automatically
        if (filtered.Count == 1)
        {
            OpenInVSCode(filtered[0].Path);
        }
    }

    private IEnumerable<RepoInfo> GetFilteredRepos()
    {
        if (string.IsNullOrWhiteSpace(searchQuery))
            return repos;
        
        var filtered = repos.Where(r => r.Name.Contains(searchQuery, StringComparison.OrdinalIgnoreCase));
        
        return filtered;
    }

    private void OpenInVSCode(string path)
    {
        try
        {
            var process = new Process
            {
                StartInfo = new ProcessStartInfo
                {
                    FileName = "code",
                    Arguments = $"\"{path}\"",
                    UseShellExecute = true,
                    CreateNoWindow = true
                }
            };
            process.Start();
        }
        catch (Exception ex)
        {
            // Handle error
        }
    }

    private class RepoInfo
    {
        public string Name { get; set; } = "";
        public string Path { get; set; } = "";
    }
}