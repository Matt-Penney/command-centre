@namespace CommandCentre.Components
@using System.Diagnostics
@using CommandCentre.Models
@using CommandCentre.Services
@implements IDisposable
@inject RepoService RepoService

<Panel Title="üîÄ Git Status" BorderColor="@Color.Green">
    <Rows>
        @foreach (var repo in _repos)
        {
            <Columns>
                <Markup Content="@($"{repo.Name}:")" Foreground="@Color.Grey" />
                <Markup Content="@GetGitStatusMarkup(_repoStatuses[repo.Name])" />
            </Columns>
        }
    </Rows>
</Panel>

@code {
    private List<RepoInfo> _repos = new();
    private Dictionary<string, RepoStatus> _repoStatuses = new();
    private bool _disposed = false;

    protected override async Task OnInitializedAsync()
    {
        _repos = RepoService.GetAllRepos();

        foreach (var repo in _repos)
        {
            _repoStatuses[repo.Name] = new RepoStatus 
            { 
                Name = repo.Name, 
                HasChanges = false, 
                ChangeCount = 0,
                IsLoading = true 
            };
        }

        await LoadGitStatuses();
    }

    private async Task LoadGitStatuses()
    {
        if (_disposed) return;

        foreach (var repo in _repos)
        {
            if (_disposed) return;
            
            await LoadSingleRepoStatus(repo);
            await InvokeAsync(StateHasChanged);
            
            await Task.Delay(500); // Small delay to prevent overwhelming
        }
    }

    private async Task<RepoStatus> LoadSingleRepoStatus(RepoInfo repo)
    {
        if (_disposed) return new RepoStatus { Name = repo.Name, HasChanges = false, ChangeCount = 0, IsLoading = false };
        
        try
        {
            var status = await GetRepoStatus(repo);
            
            if (!_disposed)
            {
                _repoStatuses[repo.Name] = status;
            }
            
            return status;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error checking git status for {repo.Name}: {ex.Message}");
            
            var errorStatus = new RepoStatus 
            { 
                Name = repo.Name, 
                HasChanges = false, 
                ChangeCount = 0,
                IsLoading = false 
            };
            
            if (!_disposed)
            {
                _repoStatuses[repo.Name] = errorStatus;
            }
            
            return errorStatus;
        }
    }

    private async Task<RepoStatus> GetRepoStatus(RepoInfo repo)
    {
        var output = await RunBashCommand($"cd '{repo.Path}' 2>/dev/null && git status --porcelain 2>/dev/null || echo ''");
        var hasChanges = !string.IsNullOrWhiteSpace(output);
        
        return new RepoStatus
        {
            Name = repo.Name,
            HasChanges = hasChanges,
            ChangeCount = hasChanges ? output.Split('\n', StringSplitOptions.RemoveEmptyEntries).Length : 0,
            IsLoading = false
        };
    }

    private string GetGitStatusMarkup(RepoStatus status)
    {
        if (status.IsLoading) return "‚è≥";
        return status.HasChanges ? "üö®" : "‚úÖ";
    }

    private async Task<string> RunBashCommand(string command)
    {
        using var process = new Process
        {
            StartInfo = new ProcessStartInfo
            {
                FileName = "/bin/bash",
                Arguments = $"-c \"{command}\"",
                UseShellExecute = false,
                RedirectStandardOutput = true,
                CreateNoWindow = true
            }
        };
        process.Start();
        var output = await process.StandardOutput.ReadToEndAsync();
        await process.WaitForExitAsync();
        return output.Trim();
    }

    public void Dispose()
    {
        _disposed = true;
    }

    private class RepoStatus
    {
        public string Name { get; set; } = "";
        public bool HasChanges { get; set; }
        public int ChangeCount { get; set; }
        public bool IsLoading { get; set; } = false;
    }
}