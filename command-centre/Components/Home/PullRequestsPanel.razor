@namespace CommandCentre.Components.Home

@using CommandCentre.Data
@using CommandCentre.Services
@using CommandCentre.Models
@using CommandCentre.Components

@implements IDisposable

@inject GitHubService GitHubService
@inject Data.GlobalState GlobalState

<!-- ToDo: for some reason windows doesnt re-render, need to change focus to have this come out of loading state -->
<!-- ToDo: use WSL on windows to run this rather than powershell, do this before trying to fix any windows-specific issue -->
<Panel Title="üîÄ My Open PRs" BorderColor="@Color.Magenta">
    <Rows>
        @if (GlobalState.IsGitHubAuthenticated == false)
        {
            <Markup Content="‚ö†Ô∏è GitHub CLI not authenticated" Foreground="@Color.Yellow" />
            <Markup Content="Install: brew install gh" Foreground="@Color.Grey" />
            <Markup Content="Then run: gh auth login" Foreground="@Color.Grey" />
        }
        else if (_loadingPRs)
        {
            <LoadingSpinner loadingMessage="Loading Pull Requests..."  />
        }
        else
        {
            @if (_pullRequests.Any())
            {
                foreach (var pr in _pullRequests)
                {
                    var statusEmoji = pr.BuildStatus switch
                    {
                        "success" => "‚úÖ",
                        "failure" => "‚ùå",
                        "pending" => "‚è≥",
                        _ => "‚ùì"
                    };
                    
                    <Markup Content="@($"{statusEmoji} #{pr.Number} - {pr.Title}")" Foreground="@Color.White" Link="@pr.Url" />
                    <Markup Content="@($"    {pr.Repo} ‚Ä¢ {pr.CreatedAt:MMM dd}")" Foreground="@Color.Grey70" />
                }
                <Newline />
            }
            else
            {
                <Markup Content="No open pull requests" Foreground="@Color.Grey" />
                <Newline />
            }
            
            @if (_loadStatuses.Any())
            {
                <TextButton Content="@(_showDetails ? "‚ñº Hide Details" : "‚ñ∂ Show Details")" 
                            OnClick="@(() => { _showDetails = !_showDetails; StateHasChanged(); })" />
                
                @if (_showDetails)
                {
                    <Newline />
                    <Markup Content="Repo Load Status:" Foreground="@Color.Cyan" Decoration="@Decoration.Bold" />
                    foreach (var status in _loadStatuses)
                    {
                        var color = status.Success ? Color.Green : Color.Red;
                        var emoji = status.Success ? "‚úÖ" : "‚ùå";
                        <Markup Content="@($"{emoji} {status.RepoName}: {status.Message}")" Foreground="@color" />
                    }
                }
            }
        }
    </Rows>
</Panel>

@code {
    private List<PullRequest> _pullRequests = new();
    private List<PRLoadStatus> _loadStatuses = new();
    private bool _loadingPRs = false;
    private bool _disposed = false;
    private bool _showDetails = false;

    protected override async Task OnInitializedAsync()
    {
        GlobalState.OnChange += StateHasChanged;
        
        // Check GitHub authentication status on first init
        if (GlobalState.IsGitHubAuthenticated == null)
        {
            bool result = await GitHubService.CheckAuthenicationStatus();
            GlobalState.SetGitHubAuthenticated(result);
        }

        if (GlobalState.IsGitHubAuthenticated.Value)
        {
            await LoadPullRequests();
            return;
        }
    }

    private async Task LoadPullRequests()
    {
        if (_disposed) return;
        
        _loadingPRs = true;
        await InvokeAsync(StateHasChanged);
        
        try
        {
            (_pullRequests, _loadStatuses) = await GitHubService.GetMyOpenPullRequests();
        }
        catch (Exception ex)
        {
            _loadStatuses.Add(new PRLoadStatus
            {
                RepoName = "System",
                Success = false,
                Message = $"Error: {ex.Message}"
            });
        }
        finally
        {
            _loadingPRs = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    public void Dispose()
    {
        _disposed = true;
        GlobalState.OnChange -= StateHasChanged;
    }
}