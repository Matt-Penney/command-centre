@namespace CommandCentre.Components
@using System.Diagnostics
@implements IDisposable
@inject CommandService CommandService

<Panel Title="ðŸ’» System Stats" BorderColor="@Color.Blue">
    <Rows>
        <Columns>
            <Markup Content="CPU:" Foreground="@Color.Grey" />
            <Markup Content="@($"{_cpuUsage}%")" Foreground="@Color.Green" />
        </Columns>
        <Columns>
            <Markup Content="Memory:" Foreground="@Color.Grey" />
            <Markup Content="@($"{_memoryUsage}GB / {_totalMemory}GB")" Foreground="@Color.Yellow"/>
        </Columns>
        <Columns>
            <Markup Content="Temperature:" Foreground="@Color.Grey" />
            <Markup Content="@($"{_temperature}Â°C")" Foreground="@Color.Chartreuse1" />
        </Columns>
        <Columns>
            <Markup Content="Uptime:" Foreground="@Color.Grey" />
            <Markup Content="@($"{_uptime}")" Foreground="@Color.Cyan" />
        </Columns>
    </Rows>
</Panel>

@code {
    private string _cpuUsage = "0";
    private string _memoryUsage = "0";
    private string _totalMemory = "16";
    private string _temperature = "0";
    private string _uptime = "0h 0m";
    private System.Timers.Timer? _statsTimer;
    private bool _disposed = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadSystemStats();
        
        // Update every 5 seconds
        _statsTimer = new System.Timers.Timer(5000);
        _statsTimer.Elapsed += async (s, e) =>
        {
            if (!_disposed) await LoadSystemStats();
        };
        _statsTimer.Start();
    }

    private async Task LoadSystemStats()
    {
        if (_disposed) return;

        try
        {
            // Get CPU usage
            _cpuUsage = !OperatingSystem.IsWindows()
                ? await RunBashCommand("top -l 1 | grep 'CPU usage' | awk '{print $3}' | sed 's/%//'")
                : "N/A";
            
            // Get memory usage
            var pages = await RunBashCommand("vm_stat | grep 'Pages active' | awk '{print $3}' | sed 's/\\.//'");
            if (int.TryParse(pages.Trim(), out int pageCount))
            {
                _memoryUsage = ((pageCount * 4096) / (1024 * 1024 * 1024)).ToString("F1");
            }

            // Get temperature
            <!-- @* _temperature = await RunBashCommand("osx-cpu-temp | awk '{print $1}' | sed 's/Â°C//'"); *@
            _temperature = "N/A"; // Placeholder as osx-cpu-temp is not be installed -->

            // Get uptime
            var uptime = TimeSpan.FromMilliseconds(Environment.TickCount64);
            _uptime = $"{uptime.Days}d {uptime.Hours}h {uptime.Minutes}m";

            if (!_disposed) await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading system stats: {ex.Message}");
        }
    }
    
    private async Task<string> RunBashCommand(string command)
    {
        try
        {
            string fileName;
            string arguments;
            if (OperatingSystem.IsWindows())
            {
                fileName = "cmd.exe";
                arguments = $"/C {command}";
            }
            else
            {
                fileName = "/bin/bash";
                arguments = $"-c \"{command}\"";
            }

            CommandInfo commandInfo = new CommandInfo
            {
                fileName = fileName,
                arguments = arguments,
                useShellExecute = false,
                redirectStandardOutput = true,
                redirectStandardError = true,
                createNoWindow = true
            };
            var (output, error, exitCode) = await CommandService.RunAsyncCommand(commandInfo);

            return string.IsNullOrWhiteSpace(output) ? error.Trim() : output.Trim();
        }
        catch
        {
            return "N/A";
        }
    }

    public void Dispose()
    {
        _disposed = true;
        _statsTimer?.Stop();
        _statsTimer?.Dispose();
    }
}